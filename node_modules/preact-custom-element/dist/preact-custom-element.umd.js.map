{"version":3,"file":"preact-custom-element.umd.js","sources":["../src/index.js"],"sourcesContent":["import { h, cloneElement, render, hydrate, Fragment } from 'preact';\n\n/**\n * @typedef {import('./index.d.ts').PreactCustomElement} PreactCustomElement\n */\n\n/**\n * @type {import('./index.d.ts').default}\n */\nexport default function register(Component, tagName, propNames, options) {\n\tfunction PreactElement() {\n\t\tconst inst = /** @type {PreactCustomElement} */ (\n\t\t\tReflect.construct(HTMLElement, [], PreactElement)\n\t\t);\n\t\tinst._vdomComponent = Component;\n\t\tinst._root =\n\t\t\toptions && options.shadow\n\t\t\t\t? inst.attachShadow({ mode: options.mode || 'open' })\n\t\t\t\t: inst;\n\n\t\tif (options && options.adoptedStyleSheets) {\n\t\t\tinst._root.adoptedStyleSheets = options.adoptedStyleSheets;\n\t\t}\n\n\t\treturn inst;\n\t}\n\tPreactElement.prototype = Object.create(HTMLElement.prototype);\n\tPreactElement.prototype.constructor = PreactElement;\n\tPreactElement.prototype.connectedCallback = function () {\n\t\tconnectedCallback.call(this, options);\n\t};\n\tPreactElement.prototype.attributeChangedCallback = attributeChangedCallback;\n\tPreactElement.prototype.disconnectedCallback = disconnectedCallback;\n\n\t/**\n\t * @type {string[]}\n\t */\n\tpropNames =\n\t\tpropNames ||\n\t\tComponent.observedAttributes ||\n\t\tObject.keys(Component.propTypes || {});\n\tPreactElement.observedAttributes = propNames;\n\n\tif (Component.formAssociated) {\n\t\tPreactElement.formAssociated = true;\n\t}\n\n\t// Keep DOM properties and Preact props in sync\n\tpropNames.forEach((name) => {\n\t\tObject.defineProperty(PreactElement.prototype, name, {\n\t\t\tget() {\n\t\t\t\treturn this._vdom\n\t\t\t\t\t? this._vdom.props[name]\n\t\t\t\t\t: this._props[name];\n\t\t\t},\n\t\t\tset(v) {\n\t\t\t\tif (this._vdom) {\n\t\t\t\t\tthis.attributeChangedCallback(name, null, v);\n\t\t\t\t} else {\n\t\t\t\t\tif (!this._props) this._props = {};\n\t\t\t\t\tthis._props[name] = v;\n\t\t\t\t}\n\n\t\t\t\t// Reflect property changes to attributes if the value is a primitive\n\t\t\t\tconst type = typeof v;\n\t\t\t\tif (\n\t\t\t\t\tv == null ||\n\t\t\t\t\ttype === 'string' ||\n\t\t\t\t\ttype === 'boolean' ||\n\t\t\t\t\ttype === 'number'\n\t\t\t\t) {\n\t\t\t\t\tthis.setAttribute(name, v);\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\t});\n\n\tcustomElements.define(\n\t\ttagName || Component.tagName || Component.displayName || Component.name,\n\t\tPreactElement\n\t);\n\n\treturn PreactElement;\n}\n\nfunction ContextProvider(props) {\n\tthis.getChildContext = () => props.context;\n\t// eslint-disable-next-line no-unused-vars\n\tconst { context, children, ...rest } = props;\n\treturn cloneElement(children, rest);\n}\n\n/**\n * @this {PreactCustomElement}\n */\nfunction connectedCallback(options) {\n\t// Obtain a reference to the previous context by pinging the nearest\n\t// higher up node that was rendered with Preact. If one Preact component\n\t// higher up receives our ping, it will set the `detail` property of\n\t// our custom event. This works because events are dispatched\n\t// synchronously.\n\tconst event = new CustomEvent('_preact', {\n\t\tdetail: {},\n\t\tbubbles: true,\n\t\tcancelable: true,\n\t});\n\tthis.dispatchEvent(event);\n\tconst context = event.detail.context;\n\n\tthis._vdom = h(\n\t\tContextProvider,\n\t\t{ ...this._props, context },\n\t\ttoVdom(this, this._vdomComponent, options)\n\t);\n\t(this.hasAttribute('hydrate') ? hydrate : render)(this._vdom, this._root);\n}\n\n/**\n * Camel-cases a string\n * @param {string} str The string to transform to camelCase\n * @returns camel case version of the string\n */\nfunction toCamelCase(str) {\n\treturn str.replace(/-(\\w)/g, (_, c) => (c ? c.toUpperCase() : ''));\n}\n\n/**\n * Changed whenver an attribute of the HTML element changed\n * @this {PreactCustomElement}\n * @param {string} name The attribute name\n * @param {unknown} oldValue The old value or undefined\n * @param {unknown} newValue The new value\n */\nfunction attributeChangedCallback(name, oldValue, newValue) {\n\tif (!this._vdom) return;\n\t// Attributes use `null` as an empty value whereas `undefined` is more\n\t// common in pure JS components, especially with default parameters.\n\t// When calling `node.removeAttribute()` we'll receive `null` as the new\n\t// value. See issue #50.\n\tnewValue = newValue == null ? undefined : newValue;\n\tconst props = {};\n\tprops[name] = newValue;\n\tprops[toCamelCase(name)] = newValue;\n\tthis._vdom = cloneElement(this._vdom, props);\n\trender(this._vdom, this._root);\n}\n\n/**\n * @this {PreactCustomElement}\n */\nfunction disconnectedCallback() {\n\trender((this._vdom = null), this._root);\n}\n\n/**\n * Pass an event listener to each `<slot>` that \"forwards\" the current\n * context value to the rendered child. The child will trigger a custom\n * event, where will add the context value to. Because events work\n * synchronously, the child can immediately pull of the value right\n * after having fired the event.\n */\nfunction Slot(props, context) {\n\tconst ref = (r) => {\n\t\tif (!r) {\n\t\t\tthis.ref.removeEventListener('_preact', this._listener);\n\t\t} else {\n\t\t\tthis.ref = r;\n\t\t\tif (!this._listener) {\n\t\t\t\tthis._listener = (event) => {\n\t\t\t\t\tevent.stopPropagation();\n\t\t\t\t\tevent.detail.context = context;\n\t\t\t\t};\n\t\t\t\tr.addEventListener('_preact', this._listener);\n\t\t\t}\n\t\t}\n\t};\n\tconst { useFragment, ...rest } = props;\n\treturn h(useFragment ? Fragment : 'slot', { ...rest, ref });\n}\n\nfunction toVdom(element, nodeName, options) {\n\tif (element.nodeType === 3) return element.data;\n\tif (element.nodeType !== 1) return null;\n\tlet children = [],\n\t\tprops = {},\n\t\ti = 0,\n\t\ta = element.attributes,\n\t\tcn = element.childNodes;\n\tfor (i = a.length; i--; ) {\n\t\tif (a[i].name !== 'slot') {\n\t\t\tprops[a[i].name] = a[i].value;\n\t\t\tprops[toCamelCase(a[i].name)] = a[i].value;\n\t\t}\n\t}\n\n\tfor (i = cn.length; i--; ) {\n\t\tconst vnode = toVdom(cn[i], null, options);\n\t\t// Move slots correctly\n\t\tconst name = cn[i].slot;\n\t\tif (name) {\n\t\t\tprops[name] = h(Slot, { name }, vnode);\n\t\t} else {\n\t\t\tchildren[i] = vnode;\n\t\t}\n\t}\n\n\tconst shadow = !!(options && options.shadow);\n\n\t// Only wrap the topmost node with a slot\n\tconst wrappedChildren = nodeName\n\t\t? h(Slot, { useFragment: !shadow }, children)\n\t\t: children;\n\n\tif (!shadow && nodeName) {\n\t\telement.innerHTML = '';\n\t}\n\treturn h(nodeName || element.nodeName.toLowerCase(), props, wrappedChildren);\n}\n"],"names":["ContextProvider","props","this","getChildContext","context","children","rest","_objectWithoutPropertiesLoose","_excluded","cloneElement","connectedCallback","options","event","CustomEvent","detail","bubbles","cancelable","dispatchEvent","_vdom","h","_extends","_props","toVdom","_vdomComponent","hasAttribute","hydrate","render","_root","toCamelCase","str","replace","_","c","toUpperCase","attributeChangedCallback","name","oldValue","newValue","undefined","disconnectedCallback","Slot","_this","useFragment","_excluded2","Fragment","ref","r","_listener","stopPropagation","addEventListener","removeEventListener","element","nodeName","nodeType","data","i","a","attributes","cn","childNodes","length","value","vnode","slot","shadow","wrappedChildren","innerHTML","toLowerCase","Component","tagName","propNames","PreactElement","inst","Reflect","construct","HTMLElement","attachShadow","mode","adoptedStyleSheets","prototype","Object","create","constructor","call","observedAttributes","keys","propTypes","formAssociated","forEach","defineProperty","get","set","v","type","setAttribute","customElements","define","displayName"],"mappings":"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"}